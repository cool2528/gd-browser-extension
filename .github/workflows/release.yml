name: Release Extension

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰

jobs:
  build-and-release:
    name: Build and Release Extension
    runs-on: ubuntu-latest

    permissions:
      contents: write  # å…è®¸åˆ›å»º release å’Œä¸Šä¼ æ–‡ä»¶

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºæå– commit ä¿¡æ¯

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci

      # 4. æå–ç‰ˆæœ¬å·ï¼ˆä» tag ä¸­å»æ‰ 'v' å‰ç¼€ï¼‰
      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      # 5. æ›´æ–° manifest.json å’Œ package.json ä¸­çš„ç‰ˆæœ¬å·
      - name: Update version in manifest and package.json
        run: |
          # æ›´æ–° manifest.json
          sed -i "s/\"version\": \".*\"/\"version\": \"${{ steps.version.outputs.VERSION }}\"/" manifest.json

          # æ›´æ–° package.json
          sed -i "s/\"version\": \".*\"/\"version\": \"${{ steps.version.outputs.VERSION }}\"/" package.json

      # 6. ç¼–è¯‘æ‰©å±•ï¼ˆChrome ç‰ˆæœ¬ï¼‰
      - name: Build Chrome Extension
        run: npm run build:chrome

      # 7. æ‰“åŒ… Chrome ç‰ˆæœ¬
      - name: Package Chrome Extension
        run: |
          cd dist
          zip -r ../gdownload-extension-chrome-v${{ steps.version.outputs.VERSION }}.zip *
          cd ..

      # 8. æ¸…ç† dist ç›®å½•
      - name: Clean dist directory
        run: rm -rf dist

      # 9. ç¼–è¯‘æ‰©å±•ï¼ˆFirefox ç‰ˆæœ¬ï¼‰
      - name: Build Firefox Extension
        run: npm run build:firefox

      # 10. æ‰“åŒ… Firefox ç‰ˆæœ¬
      - name: Package Firefox Extension
        run: |
          cd dist
          zip -r ../gdownload-extension-firefox-v${{ steps.version.outputs.VERSION }}.zip *
          cd ..

      # 11. æ¸…ç† dist ç›®å½•
      - name: Clean dist directory again
        run: rm -rf dist

      # 12. ç¼–è¯‘æ‰©å±•ï¼ˆEdge ç‰ˆæœ¬ï¼‰
      - name: Build Edge Extension
        run: npm run build:edge

      # 13. æ‰“åŒ… Edge ç‰ˆæœ¬
      - name: Package Edge Extension
        run: |
          cd dist
          zip -r ../gdownload-extension-edge-v${{ steps.version.outputs.VERSION }}.zip *
          cd ..

      # 14. è·å–æœ€åä¸€æ¬¡ commit ä¿¡æ¯ä½œä¸º release body
      - name: Get last commit message
        id: commit_message
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s%n%n%b")
          echo "COMMIT_MSG<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 15. ç”Ÿæˆ release notes
      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ğŸš€ GDownload Browser Extension ${{ steps.version.outputs.VERSION }}

          ### ğŸ“ æ›´æ–°å†…å®¹

          ${{ steps.commit_message.outputs.COMMIT_MSG }}

          ---

          ### ğŸ“¦ ä¸‹è½½è¯´æ˜

          è¯·æ ¹æ®ä½ çš„æµè§ˆå™¨é€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ä¸‹è½½ï¼š

          | æµè§ˆå™¨ | æ–‡ä»¶ | è¯´æ˜ |
          |--------|------|------|
          | **Chrome** | `gdownload-extension-chrome-v${{ steps.version.outputs.VERSION }}.zip` | é€‚ç”¨äº Chrome 110+ |
          | **Firefox** | `gdownload-extension-firefox-v${{ steps.version.outputs.VERSION }}.zip` | é€‚ç”¨äº Firefox 115+ |
          | **Edge** | `gdownload-extension-edge-v${{ steps.version.outputs.VERSION }}.zip` | é€‚ç”¨äº Edge 110+ |

          ### ğŸ“– å®‰è£…æ­¥éª¤

          #### Chrome / Edge

          1. ä¸‹è½½å¯¹åº”çš„ `.zip` æ–‡ä»¶
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. æ‰“å¼€ `chrome://extensions/`ï¼ˆChromeï¼‰æˆ– `edge://extensions/`ï¼ˆEdgeï¼‰
          4. å¯ç”¨"å¼€å‘è€…æ¨¡å¼"
          5. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"
          6. é€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹

          #### Firefox

          1. ä¸‹è½½ `.zip` æ–‡ä»¶
          2. æ‰“å¼€ `about:debugging#/runtime/this-firefox`
          3. ç‚¹å‡»"ä¸´æ—¶è½½å…¥é™„åŠ ç»„ä»¶"
          4. é€‰æ‹©è§£å‹åæ–‡ä»¶å¤¹ä¸­çš„ `manifest.json`

          ### ğŸ”— ç›¸å…³é“¾æ¥

          - [GDownload ä¸»ç¨‹åº](https://github.com/cool2528/GDownload)
          - [å®Œæ•´æ–‡æ¡£](https://github.com/cool2528/gd-browser-extension/blob/main/README.zh-CN.md)
          - [é—®é¢˜åé¦ˆ](https://github.com/cool2528/gd-browser-extension/issues)

          ### âœ… ç³»ç»Ÿè¦æ±‚

          - **æµè§ˆå™¨**: Chrome 110+ / Firefox 115+ / Edge 110+
          - **GDownload**: 1.0.0+ (éœ€å¯ç”¨ aria2c)
          - **aria2c**: 1.36.0+ (GDownload è‡ªå¸¦)
          EOF

          # è¾“å‡ºå®Œæ•´çš„ release notes
          cat release_notes.md

      # 16. åˆ›å»º GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: GDownload Extension v${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            gdownload-extension-chrome-v${{ steps.version.outputs.VERSION }}.zip
            gdownload-extension-firefox-v${{ steps.version.outputs.VERSION }}.zip
            gdownload-extension-edge-v${{ steps.version.outputs.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 17. ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•ï¼‰
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extension-packages-v${{ steps.version.outputs.VERSION }}
          path: |
            gdownload-extension-chrome-v${{ steps.version.outputs.VERSION }}.zip
            gdownload-extension-firefox-v${{ steps.version.outputs.VERSION }}.zip
            gdownload-extension-edge-v${{ steps.version.outputs.VERSION }}.zip
          retention-days: 30
